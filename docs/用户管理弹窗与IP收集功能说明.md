# ç”¨æˆ·ç®¡ç†å¼¹çª—æ“ä½œä¸IPæ”¶é›†åŠŸèƒ½è¯´æ˜

## æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°ä¸ºåå°ç®¡ç†ç³»ç»Ÿæ·»åŠ äº†ä¸¤ä¸ªé‡è¦åŠŸèƒ½ï¼š
1. **ç”¨æˆ·æ“ä½œå¼¹çª—** - ä½¿ç”¨ç¾è§‚çš„å¼¹çª—æ›¿ä»£åŸæœ‰çš„ä¸‹æ‹‰èœå•æ“ä½œ
2. **æ³¨å†ŒIPæ”¶é›†** - åœ¨ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨æ”¶é›†å¹¶ä¿å­˜IPåœ°å€

## åŠŸèƒ½ä¸€ï¼šç”¨æˆ·æ“ä½œå¼¹çª—

### æ–°å¢æ–‡ä»¶

1. **[`public/static/admin/css/modal.css`](public/static/admin/css/modal.css)** - å¼¹çª—ç»„ä»¶æ ·å¼
   - å®Œæ•´çš„å¼¹çª—æ ·å¼ç³»ç»Ÿ
   - æ”¯æŒå¤šç§å°ºå¯¸ï¼ˆsm, md, lg, xl, fullï¼‰
   - å¤šç§ç±»å‹ï¼ˆinfo, success, warning, dangerï¼‰
   - å“åº”å¼è®¾è®¡
   - ä¼˜é›…çš„åŠ¨ç”»æ•ˆæœ

2. **[`public/static/admin/js/modal.js`](public/static/admin/js/modal.js)** - å¼¹çª—ç»„ä»¶JavaScript
   - ModalManager å…¨å±€å¼¹çª—ç®¡ç†å™¨
   - Modal å¼¹çª—ç±»
   - UserActionModal ç”¨æˆ·æ“ä½œä¸“ç”¨API
   - æ”¯æŒé”®ç›˜æ“ä½œå’Œç„¦ç‚¹é™·é˜±

### ä¿®æ”¹æ–‡ä»¶

1. **[`app/admin/views/layout.php`](app/admin/views/layout.php:24)** - å¼•å…¥å¼¹çª—æ ·å¼å’Œè„šæœ¬
   ```php
   <?php if ($currentPage === 'crm-users'): ?>
   <!-- å¼¹çª—ç»„ä»¶æ ·å¼ -->
   <link rel="stylesheet" href="/static/admin/css/modal.css?v=<?= $assetVersion ?>">
   <?php endif; ?>
   ```

2. **[`app/admin/views/crm/users.php`](app/admin/views/crm/users.php:236)** - æ›´æ–°æ“ä½œæŒ‰é’®
   - å°†åŸæœ‰çš„ä¸‹æ‹‰èœå•æ›¿æ¢ä¸ºå¼¹çª—è§¦å‘æŒ‰é’®
   - æ·»åŠ ç”¨æˆ·æ•°æ®å±æ€§ï¼ˆid, name, email, statusï¼‰

3. **[`public/static/admin/js/crm-users.js`](public/static/admin/js/crm-users.js:60)** - æ·»åŠ å¼¹çª—ç»‘å®šé€»è¾‘
   - `handleUserActionClick()` - å¤„ç†æ“ä½œæŒ‰é’®ç‚¹å‡»
   - `executeUserAction()` - æ‰§è¡Œç”¨æˆ·æ“ä½œ

### åŠŸèƒ½ç‰¹æ€§

#### å¼¹çª—ç±»å‹

| ç±»å‹ | å›¾æ ‡ | ç”¨é€” |
|------|------|------|
| info | â„¹ï¸ | ä¿¡æ¯æç¤º |
| success | âœ… | æˆåŠŸç¡®è®¤ |
| warning | âš ï¸ | è­¦å‘Šç¡®è®¤ |
| danger | ğŸ—‘ï¸ | å±é™©æ“ä½œ |

#### ç”¨æˆ·æ“ä½œåˆ—è¡¨

æ ¹æ®ç”¨æˆ·çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æ“ä½œé€‰é¡¹ï¼š

**æ­£å¸¸ç”¨æˆ· (active)**
- ğŸ‘ï¸ æŸ¥çœ‹è¯¦æƒ…
- âœï¸ ç¼–è¾‘ç”¨æˆ·
- â¸ï¸ ç¦ç”¨ç”¨æˆ·
- â„ï¸ å†»ç»“ç”¨æˆ·
- ğŸ—‘ï¸ åˆ é™¤ç”¨æˆ·

**ç¦ç”¨ç”¨æˆ· (disabled)**
- ğŸ‘ï¸ æŸ¥çœ‹è¯¦æƒ…
- âœï¸ ç¼–è¾‘ç”¨æˆ·
- â–¶ï¸ å¯ç”¨ç”¨æˆ·
- â„ï¸ å†»ç»“ç”¨æˆ·
- ğŸ—‘ï¸ åˆ é™¤ç”¨æˆ·

**å†»ç»“ç”¨æˆ· (frozen)**
- ğŸ‘ï¸ æŸ¥çœ‹è¯¦æƒ…
- âœï¸ ç¼–è¾‘ç”¨æˆ·
- ğŸ”¥ è§£å†»ç”¨æˆ·
- ğŸ—‘ï¸ åˆ é™¤ç”¨æˆ·

**å·²åˆ é™¤ç”¨æˆ· (deleted)**
- ğŸ‘ï¸ æŸ¥çœ‹è¯¦æƒ…
- ğŸ”„ æ¢å¤ç”¨æˆ·

#### ä½¿ç”¨ç¤ºä¾‹

```javascript
// æ˜¾ç¤ºç¡®è®¤å¼¹çª—
const confirmed = await Modal.confirm('ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ', 'ç¡®è®¤æ“ä½œ');
if (confirmed) {
    // æ‰§è¡Œæ“ä½œ
}

// æ˜¾ç¤ºè­¦å‘Šå¼¹çª—
await Modal.alert('æ“ä½œæˆåŠŸï¼', 'æç¤º', 'success');

// æ˜¾ç¤ºç”¨æˆ·æ“ä½œé€‰æ‹©å¼¹çª—
const action = await UserActionModal.show(user, userStatus);
if (action) {
    // æ‰§è¡Œé€‰ä¸­çš„æ“ä½œ
}
```

### æ ·å¼é¢„è§ˆ

å¼¹çª—é‡‡ç”¨ç°ä»£åŒ–çš„è®¾è®¡é£æ ¼ï¼š
- åŠé€æ˜èƒŒæ™¯é®ç½©ï¼Œå¸¦æ¨¡ç³Šæ•ˆæœ
- åœ†è§’å¡ç‰‡è®¾è®¡
- æ¸å˜è‰²å›¾æ ‡èƒŒæ™¯
- å¹³æ»‘çš„è¿›å…¥/é€€å‡ºåŠ¨ç”»
- å“åº”å¼å¸ƒå±€ï¼Œæ”¯æŒç§»åŠ¨ç«¯

## åŠŸèƒ½äºŒï¼šæ³¨å†ŒIPæ”¶é›†

### ä¿®æ”¹æ–‡ä»¶

1. **[`app/frontend/controller/AuthController.php`](app/frontend/controller/AuthController.php:1036)** - æ³¨å†Œæ–¹æ³•
   - åœ¨ç”¨æˆ·åˆ›å»ºæ—¶è·å–å®¢æˆ·ç«¯IP
   - å°†IPåœ°å€ä¿å­˜åˆ°æ•°æ®åº“

2. **[`app/frontend/controller/AuthController.php`](app/frontend/controller/AuthController.php:1684)** - æ–°å¢æ–¹æ³•
   - `getClientIp()` - è·å–å®¢æˆ·ç«¯IPåœ°å€
   - `isValidIp()` - éªŒè¯IPåœ°å€æ ¼å¼

### æ•°æ®åº“å˜æ›´

**è¿ç§»æ–‡ä»¶**: [`database/migrations/008_add_register_ip_to_users.sql`](database/migrations/008_add_register_ip_to_users.sql)

```sql
ALTER TABLE `sn_users` ADD COLUMN `register_ip` varchar(45) DEFAULT NULL COMMENT 'æ³¨å†ŒIPåœ°å€' AFTER `phone`;
CREATE INDEX `idx_register_ip` ON `sn_users` (`register_ip`);
```

### IPè·å–é€»è¾‘

ç³»ç»ŸæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§è·å–å®¢æˆ·ç«¯IPï¼š

1. **HTTP_CF_CONNECTING_IP** - Cloudflare CDN
2. **HTTP_X_REAL_IP** - Nginxä»£ç†
3. **HTTP_X_FORWARDED_FOR** - é€šç”¨ä»£ç†/è´Ÿè½½å‡è¡¡
4. **HTTP_CLIENT_IP** - éƒ¨åˆ†ä»£ç†
5. **REMOTE_ADDR** - ç›´è¿IP

### IPéªŒè¯è§„åˆ™

- è¿‡æ»¤å†…ç½‘IPï¼ˆ127.0.0.1, ::1ï¼‰
- è¿‡æ»¤localhost
- éªŒè¯IPv4æ ¼å¼ï¼ˆå…¬ç½‘åœ°å€ï¼‰
- éªŒè¯IPv6æ ¼å¼ï¼ˆå…¬ç½‘åœ°å€ï¼‰
- è‡ªåŠ¨å¤„ç†X-Forwarded-Forå¤šIPæƒ…å†µï¼ˆå–ç¬¬ä¸€ä¸ªï¼‰

### å®‰å…¨ç‰¹æ€§

1. **é˜²ä¼ªé€ ** - ä¼˜å…ˆä½¿ç”¨CDN/ä»£ç†æä¾›çš„çœŸå®IPå¤´
2. **IPéªŒè¯** - åªæ¥å—æœ‰æ•ˆçš„å…¬ç½‘IPåœ°å€
3. **ç´¢å¼•ä¼˜åŒ–** - ä¸ºregister_ipå­—æ®µæ·»åŠ ç´¢å¼•ï¼Œä¾¿äºæŸ¥è¯¢
4. **å®¡è®¡è¿½è¸ª** - è®°å½•æ³¨å†ŒIPç”¨äºå®‰å…¨å®¡è®¡å’Œåæ¬ºè¯ˆ

### åº”ç”¨åœºæ™¯

1. **å®‰å…¨å®¡è®¡** - è¿½è¸ªæ¶æ„æ³¨å†Œæ¥æº
2. **åæ¬ºè¯ˆ** - è¯†åˆ«æ‰¹é‡æ³¨å†Œè¡Œä¸º
3. **åœ°åŸŸåˆ†æ** - ç»Ÿè®¡ç”¨æˆ·æ³¨å†Œåœ°åŸŸåˆ†å¸ƒ
4. **é£æ§è§„åˆ™** - åŸºäºIPçš„æ³¨å†Œé™åˆ¶

## éƒ¨ç½²æ­¥éª¤

### 1. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
# æ‰§è¡Œè¿ç§»æ–‡ä»¶
mysql -uç”¨æˆ·å -pæ•°æ®åº“å < database/migrations/008_add_register_ip_to_users.sql
```

æˆ–ä½¿ç”¨ç³»ç»Ÿè¿ç§»è„šæœ¬ï¼š
```bash
php scripts/run_migration.php 008_add_register_ip_to_users
```

### 2. æ¸…é™¤ç¼“å­˜

```bash
# æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
# æ¸…é™¤CDNç¼“å­˜ï¼ˆå¦‚ä½¿ç”¨ï¼‰
```

### 3. æµ‹è¯•åŠŸèƒ½

1. è®¿é—®ç”¨æˆ·ç®¡ç†é¡µé¢
2. ç‚¹å‡»ä»»æ„ç”¨æˆ·çš„"æ“ä½œ"æŒ‰é’®
3. ç¡®è®¤å¼¹çª—æ­£å¸¸æ˜¾ç¤º
4. æµ‹è¯•å„é¡¹æ“ä½œåŠŸèƒ½
5. æ³¨å†Œæ–°ç”¨æˆ·ï¼ŒéªŒè¯IPæ”¶é›†åŠŸèƒ½

## æŠ€æœ¯ç»†èŠ‚

### å¼¹çª—ç»„ä»¶æ¶æ„

```
ModalManager (å…¨å±€ç®¡ç†å™¨)
â”œâ”€â”€ create(options) - åˆ›å»ºå¼¹çª—
â”œâ”€â”€ confirm(message, title) - ç¡®è®¤å¼¹çª—
â”œâ”€â”€ alert(message, title, type) - è­¦å‘Šå¼¹çª—
â””â”€â”€ userActions(user, actions) - ç”¨æˆ·æ“ä½œå¼¹çª—

Modal (å¼¹çª—ç±»)
â”œâ”€â”€ _build() - æ„å»ºDOM
â”œâ”€â”€ _bindEvents() - ç»‘å®šäº‹ä»¶
â”œâ”€â”€ show() - æ˜¾ç¤ºå¼¹çª—
â”œâ”€â”€ close() - å…³é—­å¼¹çª—
â””â”€â”€ setButtonLoading() - è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€

UserActionModal (ç”¨æˆ·æ“ä½œAPI)
â”œâ”€â”€ show(user, status) - æ˜¾ç¤ºæ“ä½œå¼¹çª—
â”œâ”€â”€ _getActionsForStatus(status) - è·å–å¯ç”¨æ“ä½œ
â””â”€â”€ executeAction(userId, action, user) - æ‰§è¡Œæ“ä½œ
```

### IPæ”¶é›†æµç¨‹

```
ç”¨æˆ·æ³¨å†Œ
    â†“
AuthController::register()
    â†“
getClientIp() - è·å–IP
    â†“
isValidIp() - éªŒè¯IP
    â†“
INSERT INTO users (..., register_ip)
    â†“
ä¿å­˜åˆ°æ•°æ®åº“
```

## æµè§ˆå™¨å…¼å®¹æ€§

- Chrome/Edge 90+
- Firefox 88+
- Safari 14+
- ç§»åŠ¨ç«¯æµè§ˆå™¨æ”¯æŒ

## å¯è®¿é—®æ€§

- âœ… é”®ç›˜å¯¼èˆªæ”¯æŒï¼ˆTab, Enter, Escapeï¼‰
- âœ… ç„¦ç‚¹é™·é˜±ï¼ˆå¼¹çª—æ‰“å¼€æ—¶ï¼‰
- âœ… ARIAæ ‡ç­¾
- âœ… ç„¦ç‚¹æ¢å¤ï¼ˆå¼¹çª—å…³é—­åï¼‰
- âœ… å‡å°‘åŠ¨ç”»æ”¯æŒï¼ˆprefers-reduced-motionï¼‰

## æ€§èƒ½ä¼˜åŒ–

1. **CSSä¼˜åŒ–**
   - ä½¿ç”¨CSSå˜é‡
   - GPUåŠ é€ŸåŠ¨ç”»
   - æœ€å°åŒ–é‡æ’é‡ç»˜

2. **JavaScriptä¼˜åŒ–**
   - äº‹ä»¶å§”æ‰˜
   - é˜²æŠ–å¤„ç†
   - æ‡’åŠ è½½

3. **æ•°æ®åº“ä¼˜åŒ–**
   - register_ipå­—æ®µç´¢å¼•
   - åˆç†çš„å­—æ®µé•¿åº¦ï¼ˆvarchar(45)æ”¯æŒIPv6ï¼‰

## æœªæ¥æ”¹è¿›æ–¹å‘

### å¼¹çª—åŠŸèƒ½
- [ ] æ”¯æŒæ‹–æ‹½ç§»åŠ¨å¼¹çª—
- [ ] æ”¯æŒå¤šå¼¹çª—å †å 
- [ ] æ·»åŠ æ›´å¤šåŠ¨ç”»æ•ˆæœ
- [ ] æ”¯æŒè‡ªå®šä¹‰ä¸»é¢˜

### IPæ”¶é›†
- [ ] è®°å½•æœ€åç™»å½•IP
- [ ] IPå˜æ›´é€šçŸ¥
- [ ] IPåœ°ç†ä½ç½®ä¿¡æ¯
- [ ] IPé£é™©è¯„åˆ†

### ç”¨æˆ·ç®¡ç†
- [ ] æ‰¹é‡æ“ä½œä½¿ç”¨å¼¹çª—
- [ ] æ“ä½œå†å²è®°å½•
- [ ] æ“ä½œæƒé™æ§åˆ¶
- [ ] æ“ä½œæ—¥å¿—å¯¼å‡º

## æ•…éšœæ’é™¤

### å¼¹çª—ä¸æ˜¾ç¤º

1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰JavaScripté”™è¯¯
2. ç¡®è®¤modal.jsæ–‡ä»¶å·²æ­£ç¡®åŠ è½½
3. æ£€æŸ¥CSSæ–‡ä»¶æ˜¯å¦æ­£ç¡®å¼•å…¥
4. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

### IPæœªè®°å½•

1. æ£€æŸ¥æ•°æ®åº“è¿ç§»æ˜¯å¦æ‰§è¡ŒæˆåŠŸ
2. ç¡®è®¤register_ipå­—æ®µå·²å­˜åœ¨
3. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
4. æ£€æŸ¥æœåŠ¡å™¨é…ç½®ï¼ˆä»£ç†/CDNï¼‰

### æ ·å¼å¼‚å¸¸

1. æ£€æŸ¥CSSæ–‡ä»¶åŠ è½½é¡ºåº
2. ç¡®è®¤æ²¡æœ‰æ ·å¼å†²çª
3. æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
4. ä½¿ç”¨å¼€å‘è€…å·¥å…·æ£€æŸ¥å…ƒç´ 

## æ€»ç»“

æœ¬æ¬¡æ›´æ–°æ˜¾è‘—æå‡äº†ç”¨æˆ·ç®¡ç†ç•Œé¢çš„äº¤äº’ä½“éªŒå’Œå®‰å…¨æ€§ï¼š

âœ… **å¼¹çª—æ“ä½œ** - æ›´ç›´è§‚ã€æ›´ç¾è§‚çš„ç”¨æˆ·æ“ä½œæ–¹å¼
âœ… **IPæ”¶é›†** - å¢å¼ºå®‰å…¨å®¡è®¡èƒ½åŠ›
âœ… **å“åº”å¼è®¾è®¡** - æ”¯æŒå„ç§è®¾å¤‡
âœ… **å¯è®¿é—®æ€§** - ç¬¦åˆWCAGæ ‡å‡†
âœ… **æ€§èƒ½ä¼˜åŒ–** - æµç•…çš„äº¤äº’ä½“éªŒ

æ‰€æœ‰æ”¹è¿›éƒ½éµå¾ªç°ä»£Webå¼€å‘æœ€ä½³å®è·µï¼Œç¡®ä¿äº†åŠŸèƒ½çš„å¯é æ€§ã€å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚
