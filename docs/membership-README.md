# 星夜阁会员体系与星夜币管理系统

## 项目概述

星夜阁会员体系与星夜币管理系统是一个完整的会员管理和虚拟货币解决方案，支持多种会员类型、灵活的充值套餐、功能权限控制和用户限制管理。

## 功能特性

### 会员体系
- **多种会员类型**: 支持月度、年度、终身会员
- **灵活配置**: 所有会员权益可在后台动态配置
- **自动续费**: 支持会员自动续费功能
- **权益管理**: 可配置不同会员等级的专属权益
- **到期提醒**: 会员到期前自动提醒用户

### 星夜币管理
- **多种套餐**: 支持不同金额的充值套餐
- **会员优惠**: 会员用户享受充值折扣和额外赠送
- **消费记录**: 详细的星夜币消费记录
- **余额管理**: 实时余额查询和更新
- **充值记录**: 完整的充值历史记录

### 功能权限
- **动态配置**: 后台可配置功能是否需要会员权限
- **细粒度控制**: 支持到具体功能级别的权限控制
- **分类管理**: 功能按分类组织管理
- **状态控制**: 可启用/禁用特定功能

### 用户限制
- **多维度限制**: 支持作品数、章节数、字数等多种限制
- **差异化配置**: 普通用户和会员用户不同限制
- **实时统计**: 实时显示使用情况和剩余额度
- **灵活调整**: 管理员可灵活调整用户限制

## 技术架构

### 数据库设计
- **会员相关表**: users, membership_packages, membership_purchase_records
- **充值相关表**: recharge_packages, recharge_records, user_token_balance
- **权限相关表**: features, vip_benefits
- **限制相关表**: user_limits, token_consumption_records

### 后端实现
- **MVC架构**: 采用Model-View-Controller设计模式
- **面向对象**: 所有业务逻辑封装在模型类中
- **事务处理**: 关键操作使用数据库事务确保数据一致性
- **错误处理**: 完善的错误处理和日志记录

### 前端实现
- **响应式设计**: 支持桌面和移动设备
- **现代UI**: 采用现代化的界面设计
- **交互体验**: 丰富的动画和交互效果
- **AJAX支持**: 无刷新页面更新数据

## 文件结构

```
├── database/migrations/
│   ├── 022_create_membership_and_token_system.sql
│   └── 023_update_user_table_add_membership_fields.sql
├── app/models/
│   ├── Feature.php
│   ├── UserLimit.php
│   ├── RechargePackage.php
│   ├── VipBenefit.php
│   ├── UserTokenBalance.php
│   ├── MembershipPackage.php
│   ├── RechargeRecord.php
│   ├── MembershipPurchaseRecord.php
│   └── User.php (已更新)
├── app/frontend/controller/
│   └── MembershipController.php
├── app/admin/controller/
│   └── MembershipController.php
├── app/frontend/views/membership/
│   ├── index.php
│   ├── packages.php
│   ├── recharge.php
│   ├── orders.php
│   └── token-records.php
├── public/static/membership/
│   ├── css/membership.css
│   └── js/membership.js
└── docs/
    └── membership-api.md
```

## 核心功能模块

### 1. 会员中心
- **会员状态显示**: 实时显示会员类型和到期时间
- **余额信息**: 显示当前星夜币余额和统计
- **使用限制**: 可视化显示各类资源的使用情况
- **会员权益**: 展示当前会员可享受的权益
- **快速操作**: 提供充值、升级等快捷入口

### 2. 会员套餐
- **套餐展示**: 清晰展示不同会员套餐的权益和价格
- **价格对比**: 支持原价、优惠价、节省金额显示
- **套餐对比**: 表格形式对比不同套餐的差异
- **购买流程**: 简化的会员购买流程

### 3. 充值中心
- **套餐选择**: 多种充值套餐供用户选择
- **热门推荐**: 突出显示热门充值套餐
- **价格计算**: 自动计算会员优惠和额外赠送
- **充值记录**: 完整的充值历史和状态

### 4. 订单管理
- **订单列表**: 支持筛选和分页的订单列表
- **订单详情**: 详细的订单信息和状态跟踪
- **状态管理**: 完整的订单状态流转
- **搜索功能**: 支持按订单号搜索

### 5. 消费记录
- **记录列表**: 详细的星夜币消费记录
- **分类筛选**: 按消费类型筛选记录
- **时间筛选**: 支持按时间范围筛选
- **统计图表**: 消费趋势的可视化展示

## 管理后台功能

### 会员管理
- **会员列表**: 查看所有会员用户信息
- **套餐管理**: 配置会员套餐和价格
- **权益管理**: 配置会员专属权益
- **统计报表**: 会员相关的数据统计

### 充值管理
- **套餐配置**: 管理充值套餐和优惠
- **订单管理**: 查看和处理充值订单
- **财务管理**: 收入统计和财务报表
- **退款处理**: 订单退款和余额调整

### 权限管理
- **功能配置**: 配置功能权限要求
- **分类管理**: 按分类组织功能权限
- **批量操作**: 支持批量启用/禁用功能
- **权限测试**: 测试功能权限配置

## 安全特性

### 数据安全
- **SQL注入防护**: 使用预处理语句防止SQL注入
- **XSS防护**: 输出数据进行适当的转义和过滤
- **CSRF防护**: 关键操作使用CSRF令牌验证
- **权限验证**: 严格的用户权限检查

### 支付安全
- **签名验证**: 支付回调进行签名验证
- **重复检查**: 防止重复提交和重复支付
- **状态校验**: 严格的订单状态校验
- **日志记录**: 完整的操作日志记录

## 性能优化

### 数据库优化
- **索引优化**: 关键字段建立合适的索引
- **查询优化**: 避免N+1查询问题
- **分页处理**: 大数据量使用分页处理
- **缓存机制**: 适当使用缓存减少数据库压力

### 前端优化
- **懒加载**: 大列表使用懒加载提升性能
- **防抖处理**: 搜索和筛选使用防抖技术
- **资源压缩**: CSS和JS文件压缩
- **CDN支持**: 静态资源支持CDN加速

## 部署说明

### 环境要求
- **PHP版本**: PHP 7.4+
- **数据库**: MySQL 5.7+ 或 MariaDB 10.2+
- **Web服务器**: Apache 2.4+ 或 Nginx 1.18+
- **浏览器**: 支持现代浏览器（Chrome、Firefox、Safari、Edge）

### 安装步骤
1. 执行数据库迁移文件
2. 配置相关参数
3. 设置文件权限
4. 测试功能正常
5. 配置定时任务（如需要）

### 配置说明
- 数据库连接配置
- 支付接口配置
- 邮件通知配置
- 文件存储路径配置

## 扩展性设计

### 插件化架构
- **支付插件**: 支持多种支付方式插件
- **通知插件**: 支持邮件、短信等通知插件
- **主题系统**: 支持自定义主题和样式
- **API扩展**: 预留API接口供第三方集成

### 多语言支持
- **国际化**: 支持多语言界面
- **本地化**: 日期、货币等本地化显示
- **动态切换**: 用户可自由切换语言
- **翻译管理**: 后台可管理翻译内容

## 监控和日志

### 操作日志
- **用户操作**: 记录用户的关键操作
- **管理操作**: 记录管理员的操作日志
- **系统日志**: 记录系统运行日志
- **错误日志**: 记录系统错误信息

### 性能监控
- **响应时间**: 监控API响应时间
- **数据库性能**: 监控数据库查询性能
- **内存使用**: 监控内存使用情况
- **错误率**: 监控系统错误率

## 测试

### 单元测试
- **模型测试**: 所有模型类的单元测试
- **控制器测试**: 控制器方法的测试
- **API测试**: API接口的功能测试
- **数据库测试**: 数据库操作的测试

### 集成测试
- **端到端测试**: 完整业务流程测试
- **支付测试**: 支付流程的集成测试
- **性能测试**: 系统性能和压力测试
- **兼容性测试**: 浏览器兼容性测试

## 版本历史

### v1.0.0 (2024-01-01)
- 初始版本发布
- 实现基础会员体系功能
- 支持星夜币充值管理
- 完成前后端界面开发
- 编写完整的API文档

## 贡献指南

### 开发环境搭建
1. 克隆项目代码
2. 安装依赖包
3. 配置数据库
4. 启动开发服务器

### 代码规范
- 遵循PSR编码规范
- 使用有意义的变量和函数名
- 添加适当的注释和文档
- 保持代码简洁和可读性

### 提交流程
1. Fork项目到个人仓库
2. 创建功能分支
3. 提交代码变更
4. 创建Pull Request
5. 代码审查和合并

## 许可证

本项目采用 MIT 许可证，详情请参阅 LICENSE 文件。

## 联系方式

- **项目地址**: https://github.com/example/starrynight-membership
- **问题反馈**: 通过GitHub Issues提交问题
- **技术支持**: support@starrynight.com
- **商务合作**: business@starrynight.com

---

*本文档最后更新时间：2024-01-01*