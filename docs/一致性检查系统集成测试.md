# 星夜创作引擎一致性检查系统集成测试

## 测试概述

本文档描述了如何测试星夜创作引擎一致性检查系统的集成功能。

## 测试环境要求

1. PHP 8.0+
2. MySQL 5.7+ 或 MariaDB 10.2+
3. Web服务器 (Apache/Nginx)
4. 已安装的向量数据库 (Pinecone/Weaviate/Milvus/Chroma)
5. 已配置的嵌入模型 (OpenAI/Voyage AI等)

## 测试步骤

### 1. 数据库测试

```bash
# 检查数据库表是否正确创建
mysql -u username -p database_name -e "SHOW TABLES LIKE '%consistency%';"

# 验证表结构
mysql -u username -p database_name -e "DESCRIBE user_consistency_configs;"
mysql -u username -p database_name -e "DESCRIBE consistency_reports;"
mysql -u username -p database_name -e "DESCRIBE core_settings;"
```

### 2. 模型测试

```bash
# 测试模型文件是否可以正确加载
php -l app/models/UserConsistencyConfig.php
php -l app/models/ConsistencyReport.php
php -l app/models/CoreSetting.php
php -l app/models/VectorDbConfig.php
php -l app/models/EmbeddingModelConfig.php
```

### 3. 控制器测试

```bash
# 测试控制器是否可以正确实例化
php -r "
require_once 'app/admin/controller/ConsistencyController.php';
\$controller = new app\admin\controller\ConsistencyController();
echo 'Controller loaded successfully';
"
```

### 4. 路由测试

访问以下URL来测试路由是否正确配置：

1. **系统配置页面**
   ```
   http://your-domain/admin/consistency/config
   ```

2. **核心设定页面**
   ```
   http://your-domain/admin/consistency/core-settings
   ```

3. **一致性检查页面**
   ```
   http://your-domain/admin/consistency/check
   ```

4. **检查报告页面**
   ```
   http://your-domain/admin/consistency/reports
   ```

5. **分析统计页面**
   ```
   http://your-domain/admin/consistency/analytics
   ```

### 5. API接口测试

使用curl或Postman测试以下API端点：

```bash
# 测试配置保存
curl -X POST http://your-domain/admin/consistency/config \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "is_enabled=1&vector_db_mode=single&sensitivity_level=0.7"

# 测试核心设定添加
curl -X POST http://your-domain/admin/consistency/core-settings \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "setting_type=worldview&title=测试世界观&content=这是一个测试世界观设定"

# 测试一致性检查
curl -X POST http://your-domain/admin/consistency/check \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "content=测试内容&check_type=full&sensitivity=0.7"
```

### 6. 前端界面测试

1. **导航测试**
   - 点击左侧导航菜单的"一致性检查"链接
   - 验证是否正确跳转到一致性检查系统
   - 测试各个子页面的导航切换

2. **表单测试**
   - 在系统配置页面填写各种配置项
   - 测试表单验证和提交功能
   - 验证配置是否正确保存

3. **模态框测试**
   - 测试添加/编辑核心设定的模态框
   - 测试批量导入功能
   - 验证模态框的打开和关闭

4. **响应式测试**
   - 在不同屏幕尺寸下测试界面布局
   - 验证移动端适配性

### 7. 集成服务测试

```bash
# 测试ConsistencyCheckIntegrationService
php -r "
require_once 'app/services/ConsistencyCheckIntegrationService.php';
\$service = new app\services\ConsistencyCheckIntegrationService();
echo 'Service loaded successfully';
"
```

### 8. 错误处理测试

1. **数据库连接错误**
   - 故意配置错误的数据库连接信息
   - 验证错误页面是否正确显示

2. **权限测试**
   - 未登录状态下访问管理页面
   - 验证是否正确重定向到登录页面

3. **数据验证错误**
   - 提交无效的表单数据
   - 验证错误提示是否正确显示

## 预期结果

### 成功标准

1. **数据库层面**
   - 所有7个表正确创建
   - 表结构符合设计规范
   - 外键关系正确建立

2. **模型层面**
   - 所有模型类可以正确实例化
   - CRUD操作正常工作
   - 数据验证规则生效

3. **控制器层面**
   - 所有路由正确注册
   - 控制器方法可以正常调用
   - 权限验证正常工作

4. **前端界面**
   - 所有页面正确渲染
   - 导航菜单正常工作
   - 表单提交和验证正常
   - 响应式布局正确显示

5. **API接口**
   - 所有API端点正确响应
   - JSON格式正确
   - 错误处理机制生效

### 性能指标

1. **页面加载时间**
   - 管理页面加载时间 < 2秒
   - 大数据量列表页面加载时间 < 3秒

2. **API响应时间**
   - 配置保存API响应时间 < 500ms
   - 一致性检查API响应时间 < 5秒

3. **内存使用**
   - 单个页面内存使用 < 50MB
   - 批量操作内存使用 < 100MB

## 故障排除

### 常见问题

1. **路由404错误**
   - 检查public/index.php中的路由配置
   - 验证URL重写规则
   - 确认控制器文件路径正确

2. **数据库连接错误**
   - 检查数据库配置文件
   - 验证数据库服务状态
   - 确认表权限设置

3. **前端样式错误**
   - 检查CSS文件路径
   - 验证静态资源访问权限
   - 确认浏览器缓存设置

4. **API响应错误**
   - 检查控制器方法实现
   - 验证请求参数格式
   - 确认响应头设置

### 调试方法

1. **启用PHP错误报告**
   ```php
   ini_set('display_errors', 1);
   ini_set('display_startup_errors', 1);
   error_reporting(E_ALL);
   ```

2. **查看错误日志**
   ```bash
   tail -f /var/log/php/error.log
   tail -f /var/log/apache2/error.log
   ```

3. **数据库查询日志**
   ```sql
   SET general_log = 1;
   SET log_output = 'FILE';
   ```

## 测试报告模板

```
# 星夜创作引擎一致性检查系统集成测试报告

## 测试环境
- PHP版本: 
- 数据库版本: 
- Web服务器: 
- 测试时间: 

## 测试结果

### 数据库测试
- [ ] 表创建测试通过
- [ ] 表结构验证通过
- [ ] 外键关系验证通过

### 模型测试
- [ ] 模型加载测试通过
- [ ] CRUD操作测试通过
- [ ] 数据验证测试通过

### 控制器测试
- [ ] 路由注册测试通过
- [ ] 控制器实例化测试通过
- [ ] 权限验证测试通过

### 前端测试
- [ ] 页面渲染测试通过
- [ ] 导航功能测试通过
- [ ] 表单功能测试通过
- [ ] 响应式布局测试通过

### API测试
- [ ] 配置API测试通过
- [ ] 核心设定API测试通过
- [ ] 一致性检查API测试通过
- [ ] 报告API测试通过

### 性能测试
- [ ] 页面加载性能达标
- [ ] API响应性能达标
- [ ] 内存使用性能达标

## 发现的问题
1. 
2. 
3. 

## 建议改进
1. 
2. 
3. 

## 测试结论
- [ ] 系统集成测试通过
- [ ] 需要修复问题后重新测试
- [ ] 系统不满足集成要求

测试人员: 
测试日期: 
```

## 总结

完成以上所有测试步骤后，星夜创作引擎一致性检查系统应该能够：

1. 正确管理用户配置
2. 有效存储和检索核心设定
3. 执行准确的一致性检查
4. 生成详细的检查报告
5. 提供全面的分析统计
6. 与星夜创作引擎无缝集成

如果所有测试都通过，说明一致性检查系统已成功集成到星夜创作引擎中。