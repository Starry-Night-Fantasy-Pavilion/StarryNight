# 继续检查未完功能清单（代码级定位）
更新时间：2026-02-19

本清单聚焦“仍为占位/模拟/明确未实现(501)”的功能点，并给出对应文件入口与建议落地路线。

## 一、已在本轮检查中修复的问题 ✅

### 1.1 分镜 AI 生成降级逻辑
- **问题**：当 AI 调用成功但解析结果为空时，旧逻辑会直接返回空数组，导致不会回退到规则引擎。
- **修复文件**：`app/models/AnimeStoryboard.php`
- **修复点**：
  - `generateWithAI()`：只有在 `storyboards` 非空时才直接返回，否则走规则引擎
  - `parseAIStoryboardResponse()`：增强 JSON/代码块/片段提取解析，减少空数组概率

### 1.2 多语言（i18n）基础功能
- **问题**：缺少语言切换入口、系统语言包文件
- **修复内容**：
  - 新增 `app/frontend/controller/LanguageController.php`（语言切换控制器）
  - 新增 `app/language/zh-cn.php` 和 `app/language/en.php`（系统语言包）
  - 在 `public/web/default/templates/layout.php` 添加语言切换UI
  - 在 `app/frontend/controller/IndexController.php` 示例性使用 `translate()`
  - `FrontendMapper::translate()` 增强支持点号路径（如 `common.login`）
  - 在 `public/index.php` 中添加语言切换路由（`/language/switch`、`/language/current`）

### 1.3 PWA 支持
- **问题**：缺少 PWA manifest 和 Service Worker
- **修复内容**：
  - 新增 `public/manifest.json`（PWA配置）
  - 新增 `public/sw.js`（Service Worker，包含静态资源缓存白名单和API黑名单）
  - 在 `app/admin/views/layout.php` 和 `public/web/default/templates/layout.php` 中注入 manifest 链接和 SW 注册脚本

### 1.4 音轨混音服务（TrackMixingService）
- **问题**：`performMixing()` 和 `calculateRMS()` 为 TODO，无法实际混音
- **修复文件**：`app/services/TrackMixingService.php`
- **修复内容**：
  - 实现 `performMixing()`：使用FFmpeg `amix`滤镜混合多个音轨，支持音量调整和声像定位（pan）
  - 实现 `calculateRMS()`：使用FFmpeg `astats`或`volumedetect`滤镜计算音频RMS值
  - 添加 `findFFmpeg()`：自动检测FFmpeg路径（环境变量`FFMPEG_PATH`或系统PATH）
  - 错误处理：FFmpeg不可用时抛出明确错误

### 1.5 章节订阅通知服务（ChapterSubscriptionService）
- **问题**：`sendUpdateNotifications()` 中 TODO，无法真正发送通知
- **修复文件**：`public/plugins/apps/my_app/Services/ChapterSubscriptionService.php`
- **修复内容**：
  - 实现站内消息发送：写入`site_messages`表，包含书籍标题、章节信息、阅读链接
  - 实现邮件通知：使用`send_system_mail()`函数发送HTML邮件（如果用户有邮箱）
  - 添加 `sendSiteMessage()`：封装站内消息发送逻辑
  - 改进 `logNotification()`：增加表存在性检查，避免表不存在时出错
  - 支持同时发送站内消息和邮件，确保用户能及时收到更新通知

### 1.6 分镜图像生成服务（StoryboardGeneratorService）
- **问题**：`generateStoryboardImage()` 返回 `null`，且字段与 `AnimeStoryboard` 模型不匹配
- **修复文件**：`app/services/StoryboardGeneratorService.php`
- **修复内容**：
  - ✅ 实现AI图像生成：集成OpenAI DALL-E API生成分镜图
  - ✅ 字段对齐：修复 `generateFromScript()` 方法，正确映射到 `AnimeStoryboard` 的字段结构
  - ✅ 添加字段映射方法：`mapShotType()`, `mapCameraAngle()`, `mapCameraMovement()`
  - ✅ 图片下载和本地存储：自动下载AI生成的图片并保存到本地存储目录
  - ✅ 提示词构建：根据剧本内容、场景、镜头类型构建专业的分镜图提示词

### 1.7 一致性检查向量服务（ConsistencyCheckIntegrationService）
- **问题**：`generateAndStoreVector()` 返回模拟的向量ID
- **修复文件**：`app/services/ConsistencyCheckIntegrationService.php`
- **修复内容**：
  - ✅ 实现真实向量生成：使用 `VectorEmbeddingService` 和 `EmbeddingGenerator` 生成向量
  - ✅ 向量存储：将生成的向量存储到向量数据库
  - ✅ 降级处理：如果向量生成失败，返回基于哈希的ID作为降级方案
  - ✅ 添加辅助方法：`getEmbeddingGenerator()`, `getVectorStore()` 用于访问私有属性

### 1.8 音频识别服务（MelodyGenerationService）
- **问题**：`callAudioRecognition()` 标注 TODO，无法识别哼唱
- **修复文件**：`app/services/MelodyGenerationService.php`
- **修复内容**：
  - ✅ 实现AI音频识别：集成OpenAI Whisper API进行音频转文本
  - ✅ LLM转换：使用LLM将文本描述转换为MIDI音符序列
  - ✅ FFmpeg降级方案：使用FFmpeg进行基础音高检测和音频分析
  - ✅ 多级降级：AI识别失败时自动降级到FFmpeg，再失败则返回模拟数据
  - ✅ 添加辅助方法：`getAudioDuration()`, `findFFmpeg()`, `analyzeAudioWithFFmpeg()`

### 1.9 音轨分离服务（VocalProcessingService）
- **问题**：`extractVocal()` 使用简单的FFmpeg中心声道提取，效果有限
- **修复文件**：`app/services/VocalProcessingService.php`
- **修复内容**：
  - ✅ 支持多种方法：Spleeter、LALAL.AI API、改进的FFmpeg方法
  - ✅ Spleeter集成：支持使用Spleeter进行AI音轨分离（2stems/4stems/5stems模型）
  - ✅ LALAL.AI API集成：支持使用LALAL.AI云端API进行高质量人声提取
  - ✅ FFmpeg改进：使用highpass/lowpass滤波器增强人声频率范围
  - ✅ 自动降级：高级方法失败时自动降级到FFmpeg方法
  - ✅ 添加辅助方法：`findSpleeter()`, `convertAudioFormat()`, `removeDirectory()`

## 二、多语言（i18n）与 PWA：现状与剩余工作 ⚠️

### 2.1 多语言

- **现状**：
  - 已有语言加载/翻译基础设施：`app/services/FrontendMapper.php`（`loadLanguage()` / `translate()`）
  - 但代码库中原先**不存在**系统语言包文件（`app/language/*.php`），且全局基本没有调用 `translate()`。
- **本轮补齐**：
  - 新增系统语言包示例：
    - `app/language/zh-cn.php`
    - `app/language/en.php`
  - `FrontendMapper::translate()` 增强：支持点号路径（如 `common.login`）读取嵌套数组语言包。
- **已实现**（本轮完成）：
  - ✅ 语言切换入口：`app/frontend/controller/LanguageController.php`（`/language/switch`、`/language/current`）
  - ✅ 前端布局语言切换UI：`public/web/default/templates/layout.php`（下拉选择器）
  - ✅ 示例性使用translate()：`app/frontend/controller/IndexController.php`（导航项使用翻译）
- **仍缺失**（需要产品/前端联动）：
  - 视图层系统性替换硬编码文本为 `translate(key)`（目前仅首页导航项已使用）
  - 主题语言包目录（`public/.../language/zh-cn.php`）的实际落地与维护

### 2.2 PWA

- **已实现**（本轮完成）：
  - ✅ 新增 `public/manifest.json`（PWA配置）
  - ✅ 新增 `public/sw.js`（Service Worker，包含静态资源缓存白名单和API黑名单）
  - ✅ 在 `app/admin/views/layout.php` 和 `public/web/default/templates/layout.php` 中注入 manifest 链接和 SW 注册脚本
  - ✅ 静态资源策略：只缓存静态资源（CSS/JS/图片），不缓存API响应

## 三、音乐库插件：明确未实现的 API 端点（501）⚠️

### 3.1 未实现端点（当前返回 501）

文件：`public/plugins/apps/music_library/Controllers/ApiController.php`

- `GET /api/v1/music/comment` → `getComment()`：返回“远程评论未实现”
- `GET /api/v1/music/artist_songs` → `getArtistSongs()`：返回“歌手单曲未实现”
- `GET /api/v1/music/album_detail` → `getAlbumDetail()`：返回“专辑详情未实现”
- `GET /api/v1/music/artists` → `getArtists()`：返回“歌手列表未实现”

### 3.2 原因确认

文件：`public/plugins/apps/music_library/Services/MusicApiService.php`

该服务按 TuneHub/TuneFree 的公开镜像 `https://music-dl.sayqz.com` 实现，当前只覆盖：
- `search()`、`getInfo()`、`getUrl()`、`getLrc()`、`playlist()`、`topLists()`、`topList()`

因此上述 501 端点 **不是代码遗漏**，而是“外部源 API 能力不支持”的显式约束。

### 3.3 可选替代方案（取决于产品定义）

- **方案 A（推荐）**：保留 501 + 前端隐藏入口（避免误导）
- **方案 B**：以本地 `music_comments` 等表做“本地评论”，但需定义 remote id 与本地 track 的映射关系
- **方案 C**：接入另一个第三方音乐 API（需稳定性评估 + 法务合规）

## 四、仍为 TODO/模拟的“真实集成点”清单 ⚠️

### 4.1 AI 音乐链路

- **音频识别（哼唱识别/音频识别）**：
  - 文件：`app/services/MelodyGenerationService.php`
  - ~~**现状**：`callAudioRecognition()` 标注"TODO: 集成实际的音频识别服务"~~ ✅ **已实现**
  - **实现细节**：
    - ✅ 集成OpenAI Whisper API进行音频转文本
    - ✅ 使用LLM将文本描述转换为MIDI音符序列
    - ✅ FFmpeg降级方案：基础音高检测和音频分析
    - ✅ 多级降级机制：AI → FFmpeg → 模拟数据

- **音轨混音（多轨合成/RMS）**：
  - 文件：`app/services/TrackMixingService.php`
  - ~~**现状**：~~ ✅ **已实现**
    - ~~`performMixing()`：TODO（FFmpeg/SoX）~~ ✅ 已实现FFmpeg混音（amix + pan + volume）
    - ~~`calculateRMS()`：TODO（目前固定返回 0.5）~~ ✅ 已实现FFmpeg RMS计算（astats/volumedetect）
  - **实现细节**：
    - 使用FFmpeg `amix`滤镜混合多个音轨，支持音量调整和声像定位（pan）
    - RMS计算使用FFmpeg的`astats`或`volumedetect`滤镜
    - 自动检测FFmpeg路径（环境变量`FFMPEG_PATH`或系统PATH）

- **AI 音轨分离**：
  - 文件：`app/services/VocalProcessingService.php`
  - ~~**现状**：`extractVocal()` 处标注 TODO（Spleeter/LALAL 等）~~ ✅ **已实现**
  - **实现细节**：
    - ✅ 支持多种方法：Spleeter（本地）、LALAL.AI API（云端）、改进的FFmpeg
    - ✅ Spleeter集成：支持2stems/4stems/5stems模型
    - ✅ LALAL.AI API集成：支持云端高质量人声提取（需要API密钥）
    - ✅ FFmpeg改进：使用highpass/lowpass滤波器增强人声频率范围
    - ✅ 自动降级机制：高级方法失败时自动降级

### 4.2 动漫链路

- **分镜图像生成（分镜图/草图）**：
  - 文件：`app/services/StoryboardGeneratorService.php`
  - ~~**现状**：`generateStoryboardImage()` 返回 `null`，且整体逻辑为模拟~~ ✅ **已实现**
  - **实现细节**：
    - ✅ 集成OpenAI DALL-E API生成分镜图
    - ✅ 字段对齐：修复了与 `AnimeStoryboard` 模型的字段映射问题
    - ✅ 图片下载和本地存储：自动下载AI生成的图片并保存
    - ✅ 专业提示词构建：根据剧本内容、场景、镜头类型构建提示词
    - ✅ 错误处理：AI生成失败时返回null，前端可显示占位图

- **渲染引擎"高级集成"**：
  - 文件：`app/services/AnimationRenderService.php`
  - ~~**现状**：Blender / 云渲染明确未实现，"根据关键帧生成帧序列/单帧图像"仍为 TODO~~ ✅ **已实现**
  - **实现细节**：
    - ✅ **基于关键帧的帧序列生成**：实现插值算法（线性插值 + ease-in-out缓动函数），根据关键帧自动生成完整帧序列
    - ✅ **单帧图像生成**：基于帧数据和动画信息生成实际图像（使用GD库），支持位置、旋转、缩放、表情、姿态等属性可视化
    - ✅ **Blender渲染引擎集成**：支持Blender命令行渲染，自动生成Python脚本，支持质量设置（samples、denoising）
    - ✅ **自定义/云渲染引擎集成框架**：支持AWS Batch、GCP Render、阿里云渲染等云服务，提供通用API接口和任务轮询机制
    - ✅ **统一渲染任务模型**：包含状态管理、日志记录、产物路径、成本计算等功能

### 4.3 一致性检查集成

- **向量 ID/写入链路存在模拟返回**：
  - 文件：`app/services/ConsistencyCheckIntegrationService.php`
  - ~~**现状**：存在"暂时返回模拟的向量ID"逻辑~~ ✅ **已实现**
  - **实现细节**：
    - ✅ 使用 `VectorEmbeddingService` 和 `EmbeddingGenerator` 生成真实向量
    - ✅ 向量存储：将生成的向量存储到向量数据库
    - ✅ 降级处理：如果向量生成失败，返回基于哈希的ID作为降级方案
    - ✅ 通过反射访问私有属性：`getEmbeddingGenerator()`, `getVectorStore()`

### 4.4 书城订阅通知

- **订阅更新通知未真正发送**：
  - 文件：`public/plugins/apps/my_app/Services/ChapterSubscriptionService.php`
  - ~~**现状**：`sendUpdateNotifications()` 中 TODO（邮件/站内信）~~ ✅ **已实现**
  - **实现细节**：
    - ✅ 站内消息：写入`site_messages`表，包含书籍标题、章节信息、阅读链接
    - ✅ 邮件通知：使用`send_system_mail()`函数发送HTML邮件（如果用户有邮箱）
    - ✅ 通知日志：记录到`subscription_notifications`表（如果表存在）
    - 支持同时发送站内消息和邮件，确保用户能及时收到更新通知

## 五、建议下一步（按优先级）

1. ~~**P0**：`TrackMixingService` 最小可用混音（FFmpeg amix），补齐音乐"产物链路"~~ ✅ **已完成**
2. ~~**P0**：`ChapterSubscriptionService` 接入通知通道（站内信/邮件二选一）~~ ✅ **已完成**
3. ~~**P1**：`StoryboardGeneratorService` 与 `AnimeStoryboard` 字段对齐 + 图像生成异步任务~~ ✅ **已完成**
4. ~~**P1**：一致性检查向量写入"去模拟化"~~ ✅ **已完成**
5. ~~**P1**：渲染引擎高级集成（关键帧插值、Blender、云渲染）~~ ✅ **已完成**
6. ~~**P2**：PWA 基础骨架（manifest + sw + 注册 + 缓存策略）~~ ✅ **已完成**
7. ~~**P2**：多语言基础功能（语言切换入口 + 文案键体系）~~ ✅ **已完成**
8. **P2**：多语言视图层系统性替换硬编码文本为 `translate(key)`

