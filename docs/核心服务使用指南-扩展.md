# 核心服务使用指南

本文档介绍项目中已实现并整合的核心服务，包括统一错误码体系、CSRF/XSS安全防护、事件系统和消息队列服务。

## 目录

1. [统一错误码体系](#统一错误码体系)
2. [CSRF/XSS安全防护](#csrfxss安全防护)
3. [事件系统](#事件系统)
4. [消息队列服务](#消息队列服务)

---

## 统一错误码体系

### 概述

错误码体系位于 `core/Exceptions/ErrorCode.php`，提供了统一的错误码定义、消息映射和HTTP状态码映射。

### 错误码格式

错误码为6位数字：
- 前两位：模块代码
- 中两位：业务代码
- 后两位：具体错误代码

### 使用方法

#### 1. 在API响应中使用

```php
use app\services\ApiResponse;
use Core\Exceptions\ErrorCode;

// 返回成功响应
ApiResponse::sendSuccess($data, '操作成功');

// 返回错误响应
ApiResponse::sendError(ErrorCode::AUTH_LOGIN_REQUIRED);
ApiResponse::sendError(ErrorCode::VALIDATION_FAILED, '自定义错误消息', ['field' => 'error']);

// 快捷方法
ApiResponse::sendError(ApiResponse::unauthorized());
ApiResponse::sendError(ApiResponse::forbidden());
ApiResponse::sendError(ApiResponse::notFound());
```

#### 2. 在控制器中使用

```php
use api\controllers\BaseApiController;
use Core\Exceptions\ErrorCode;

class MyController extends BaseApiController
{
    public function action()
    {
        // 使用errorCode方法
        $this->errorCode(ErrorCode::AUTH_PERMISSION_DENIED);
        
        // 或使用ApiResponse
        ApiResponse::sendError(ErrorCode::RESOURCE_NOT_FOUND);
    }
}
```

#### 3. 分页响应

```php
ApiResponse::sendPaginated($items, $total, $page, $pageSize);
```

### 常用错误码

| 错误码 | 常量 | 说明 |
|--------|------|------|
| 0 | SUCCESS | 成功 |
| 10001 | AUTH_FAILED | 认证失败 |
| 10011 | AUTH_LOGIN_REQUIRED | 请先登录 |
| 10012 | AUTH_PERMISSION_DENIED | 权限不足 |
| 20001 | USER_NOT_FOUND | 用户不存在 |
| 30001 | VALIDATION_FAILED | 验证失败 |
| 50001 | NOVEL_NOT_FOUND | 小说不存在 |
| 60001 | AI_SERVICE_ERROR | AI服务错误 |
| 60005 | AI_TOKEN_INSUFFICIENT | 星夜币余额不足 |
| 100001 | SECURITY_CSRF_TOKEN_MISMATCH | CSRF验证失败 |

---

## CSRF/XSS安全防护

### CSRF防护

#### 在表单中使用

```php
use Core\Security\CsrfMiddleware;

$csrf = new CsrfMiddleware();

// 生成隐藏字段
echo $csrf->field();

// 生成Meta标签（用于AJAX）
echo $csrf->meta();
```

#### 在API中验证

```php
// 在控制器中
$this->validateCsrf();  // 验证失败会自动返回错误

// 或手动验证
$token = $this->getCsrfToken();
if (!CsrfMiddleware::validate($token)) {
    ApiResponse::sendError(ErrorCode::SECURITY_CSRF_TOKEN_MISMATCH);
}
```

#### AJAX请求

```javascript
// 从Meta标签获取Token
const token = document.querySelector('meta[name="csrf-token"]').content;

// 在Header中发送
fetch('/api/endpoint', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRF-TOKEN': token
    },
    body: JSON.stringify(data)
});
```

### XSS防护

#### 清理输入

```php
use Core\Security\XssMiddleware;

$xss = new XssMiddleware();

// 清理字符串
$clean = $xss->clean($input);

// 静态方法
$clean = XssMiddleware::escape($input);
```

#### 安全输出

```php
// HTML输出
echo XssMiddleware::escape($userInput);

// 属性输出
echo XssMiddleware::escapeAttribute($value);

// JavaScript输出
echo XssMiddleware::escapeJs($value);

// URL输出
echo XssMiddleware::escapeUrl($url);

// 过滤HTML（保留安全标签）
echo XssMiddleware::filterHtml($input, ['p', 'br', 'strong', 'em']);
```

---

## 事件系统

### 概述

事件系统用于解耦代码，支持事件分发和订阅。

### 定义事件

事件常量定义在 `app/services/SystemEvents.php`：

```php
use app\services\SystemEvents;

// 用户事件
SystemEvents::USER_REGISTERED
SystemEvents::USER_LOGIN
SystemEvents::USER_LOGOUT

// AI事件
SystemEvents::AI_REQUEST_START
SystemEvents::AI_REQUEST_SUCCESS
SystemEvents::AI_TOKEN_CONSUMED

// 安全事件
SystemEvents::SECURITY_LOGIN_FAILED
SystemEvents::SECURITY_XSS_DETECTED
```

### 触发事件

```php
use app\services\EventService;
use app\services\SystemEvents;

// 通用方法
EventService::dispatch(SystemEvents::USER_REGISTERED, [
    'id' => $userId,
    'username' => $username,
    'email' => $email,
]);

// 快捷方法
EventService::userRegistered($userData);
EventService::userLogin($userData);
EventService::userLogout($userId);
EventService::aiRequest($action, $params, $userId);
EventService::aiRequestSuccess($action, $tokensUsed, $userId);
EventService::orderPaid($orderData);
EventService::securityEvent(SystemEvents::SECURITY_XSS_DETECTED, $data);
```

### 创建订阅者

```php
namespace app\subscribers;

use app\services\SystemEvents;

class MyEventSubscriber
{
    public function getSubscribedEvents(): array
    {
        return [
            SystemEvents::USER_REGISTERED => 'onUserRegistered',
            SystemEvents::USER_LOGIN => ['onUserLogin', 5], // 带优先级
        ];
    }

    public function onUserRegistered(array $data): void
    {
        // 处理用户注册事件
        $userId = $data['id'] ?? 0;
        // ...
    }

    public function onUserLogin(array $data): void
    {
        // 处理用户登录事件
    }
}
```

### 注册订阅者

```php
use app\providers\EventServiceProvider;

// 添加订阅者
EventServiceProvider::addSubscriber(MyEventSubscriber::class);
```

---

## 消息队列服务

### 概述

消息队列用于异步处理耗时任务，如发送邮件、数据处理等。

### 推送任务

```php
use app\services\QueueService;

// 基本用法
$jobId = QueueService::push(MyJob::class, [
    'param1' => 'value1',
    'param2' => 'value2',
]);

// 高优先级
$jobId = QueueService::highPriority(MyJob::class, $data);

// 低优先级
$jobId = QueueService::lowPriority(MyJob::class, $data);

// 延迟执行（5分钟后）
$jobId = QueueService::later(300, MyJob::class, $data);
```

### 发送邮件

```php
// 发送邮件
QueueService::sendEmail('user@example.com', '主题', '内容');

// 发送欢迎邮件
QueueService::sendWelcomeEmail($email, $username);

// 发送密码重置邮件
QueueService::sendPasswordResetEmail($email, $resetLink);

// 发送通知
QueueService::sendNotification($userId, '标题', '消息内容');
```

### 创建任务

```php
namespace app\jobs;

use Core\Queue\Job;
use Core\Queue\JobInterface;

class MyJob extends Job implements JobInterface
{
    protected int $maxTries = 3;  // 最大重试次数
    protected int $timeout = 60;  // 超时时间

    public function handle(): void
    {
        $param1 = $this->data['param1'] ?? null;
        
        // 执行任务逻辑
        // ...
    }

    public function failed(\Throwable $e): void
    {
        // 任务失败处理
        error_log("任务失败: " . $e->getMessage());
    }
}
```

### 运行队列工作进程

```bash
# 基本运行
php scripts/queue_worker.php

# 指定队列
php scripts/queue_worker.php high

# 带参数运行
php scripts/queue_worker.php default --sleep=2 --max_jobs=100 --memory=256

# 单次运行
php scripts/queue_worker.php default --once
```

### 队列统计

```php
$stats = QueueService::stats();
// 返回: ['queues' => [...], 'total' => 10]
```

---

## 完整示例

参考 `public/api/v1/controllers/ExampleController.php` 查看完整的使用示例。

### 用户注册示例

```php
public function register(): void
{
    $username = $this->post('username');
    $email = $this->post('email');
    $password = $this->post('password');

    // 参数验证
    if (empty($username) || empty($email) || empty($password)) {
        ApiResponse::sendError(ErrorCode::VALIDATION_REQUIRED);
    }

    // XSS清理
    $username = XssMiddleware::escape($username);

    // 创建用户
    $userId = $this->createUser([...]);

    // 触发事件（会自动发送欢迎邮件、初始化用户数据）
    EventService::userRegistered([
        'id' => $userId,
        'username' => $username,
        'email' => $email,
    ]);

    ApiResponse::sendSuccess(['user_id' => $userId], '注册成功');
}
```

---

## 文件结构

```
app/
├── services/
│   ├── ApiResponse.php        # API响应服务
│   ├── EventService.php       # 事件服务
│   ├── QueueService.php       # 队列服务
│   └── SystemEvents.php       # 系统事件定义
├── subscribers/
│   ├── EventSubscriberInterface.php
│   ├── UserEventSubscriber.php
│   └── SecurityEventSubscriber.php
├── providers/
│   └── EventServiceProvider.php
└── jobs/
    └── SendEmailJob.php

core/
├── Exceptions/
│   └── ErrorCode.php          # 错误码定义
└── Security/
    ├── CsrfMiddleware.php     # CSRF防护
    └── XssMiddleware.php      # XSS防护

public/api/
├── Controllers/
│   └── BaseApiController.php  # API基类控制器
└── v1/controllers/
    └── ExampleController.php  # 示例控制器
```
