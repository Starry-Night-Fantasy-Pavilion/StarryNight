# 星夜创作引擎一致性检查系统详细文档

## 1. 系统概述

星夜创作引擎一致性检查系统是一个基于向量数据库的智能内容一致性检测工具，旨在帮助创作者在创作过程中保持世界观、角色设定、情节发展等核心要素的一致性。系统通过向量化存储核心设定，实时检测新内容与已有设定的冲突，并提供详细的冲突报告和解决建议。

## 2. 系统架构

### 2.1 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                    星夜创作引擎一致性检查系统                    │
├─────────────────────────────────────────────────────────────┤
│  前端管理界面  │  后端API接口  │  数据库层  │  向量数据库层  │
├─────────────────────────────────────────────────────────────┤
│  配置管理    │  一致性检查   │  数据存储   │  向量存储     │
│  报告查看    │  冲突检测     │  日志记录   │  相似度搜索   │
│  分析统计    │  核心设定管理  │  用户配置   │  集群管理     │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件

#### 2.2.1 数据库层
- **用户配置表** (`user_consistency_configs`): 存储用户的一致性检查配置
- **一致性报告表** (`consistency_reports`): 存储一致性检查报告
- **向量数据库配置表** (`vector_db_configs`): 存储向量数据库连接配置
- **嵌入模型配置表** (`embedding_model_configs`): 存储嵌入模型配置
- **核心设定表** (`core_settings`): 存储项目核心设定
- **冲突记录表** (`consistency_conflicts`): 存储检测到的冲突详情
- **使用日志表** (`vector_db_usage_logs`): 存储向量数据库使用日志

#### 2.2.2 模型层
- **UserConsistencyConfig**: 用户配置管理模型
- **ConsistencyReport**: 一致性报告管理模型
- **VectorDbConfig**: 向量数据库配置模型
- **EmbeddingModelConfig**: 嵌入模型配置模型
- **CoreSetting**: 核心设定管理模型
- **ConsistencyConflict**: 冲突记录管理模型
- **VectorDbUsageLog**: 使用日志管理模型

#### 2.2.3 服务层
- **ConsistencyCheckIntegrationService**: 一致性检查集成服务
  - 与星夜创作引擎的集成接口
  - 向量数据库操作封装
  - 一致性检查算法实现
  - 冲突检测和报告生成

#### 2.2.4 控制器层
- **ConsistencyController**: 一致性检查管理控制器
  - 用户配置管理
  - 核心设定管理
  - 一致性检查操作
  - 报告查看和分析
  - 系统监控和统计

## 3. 功能特性

### 3.1 用户配置管理
- **启用/禁用一致性检查**: 用户可以选择开启或关闭一致性检查功能
- **向量数据库模式选择**: 支持单数据库和多数据库模式
- **嵌入模型选择**: 支持多种嵌入模型，包括OpenAI、Voyage AI等
- **检查频率设置**: 支持实时检查、定时检查和手动检查
- **检查范围配置**: 可配置检查的内容类型和范围
- **敏感度调整**: 可调整冲突检测的敏感度阈值

### 3.2 核心设定管理
- **世界观设定**: 存储和管理项目的世界观背景
- **角色设定**: 存储和管理角色信息、性格、能力等
- **事件设定**: 存储和管理关键事件和时间线
- **规则设定**: 存储和管理项目规则和约束
- **批量导入**: 支持批量导入核心设定数据
- **向量化处理**: 自动将核心设定转换为向量存储

### 3.3 一致性检查
- **实时检查**: 在内容创作过程中实时检测一致性
- **手动检查**: 支持手动触发一致性检查
- **多维度检测**: 从世界观、角色、事件、规则等多个维度进行检查
- **智能分析**: 使用AI技术分析冲突的严重程度和影响范围
- **解决建议**: 为检测到的冲突提供解决建议

### 3.4 报告与分析
- **详细报告**: 生成详细的一致性检查报告
- **冲突统计**: 统计冲突类型、频率和趋势
- **可视化展示**: 通过图表展示一致性检查结果
- **历史记录**: 保存历史检查记录和报告
- **导出功能**: 支持报告导出为多种格式

### 3.5 系统监控
- **使用统计**: 统计系统使用情况和性能指标
- **健康监控**: 监控向量数据库和系统健康状态
- **错误追踪**: 记录和分析系统错误
- **性能优化**: 提供性能优化建议

## 4. 技术实现

### 4.1 数据库设计

#### 4.1.1 用户配置表
```sql
CREATE TABLE user_consistency_configs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    project_id INT,
    is_enabled BOOLEAN DEFAULT FALSE,
    vector_db_mode ENUM('single', 'multi') DEFAULT 'single',
    primary_vector_db_id INT,
    embedding_model_id INT,
    check_frequency ENUM('realtime', 'scheduled', 'manual') DEFAULT 'manual',
    check_scope JSON,
    sensitivity_level DECIMAL(3,2) DEFAULT 0.7,
    auto_fix BOOLEAN DEFAULT FALSE,
    notification_settings JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (primary_vector_db_id) REFERENCES vector_db_configs(id),
    FOREIGN KEY (embedding_model_id) REFERENCES embedding_model_configs(id)
);
```

#### 4.1.2 核心设定表
```sql
CREATE TABLE core_settings (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    project_id INT,
    setting_type ENUM('worldview', 'character', 'event', 'rule', 'other') NOT NULL,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    metadata JSON,
    vector_id VARCHAR(255),
    embedding_model_id INT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (embedding_model_id) REFERENCES embedding_model_configs(id)
);
```

### 4.2 向量数据库集成

#### 4.2.1 支持的向量数据库
- **Pinecone**: 云端向量数据库服务
- **Weaviate**: 开源向量搜索引擎
- **Milvus**: 开源向量数据库
- **Chroma**: 轻量级向量数据库
- **Qdrant**: 向量相似性搜索引擎

#### 4.2.2 嵌入模型支持
- **OpenAI**: text-embedding-ada-002, text-embedding-3-small, text-embedding-3-large
- **Voyage AI**: voyage-3, voyage-3-large, voyage-3-lite
- **本地模型**: 通过Ollama和LmStudio支持本地嵌入模型

### 4.3 一致性检查算法

#### 4.3.1 向量相似度计算
使用余弦相似度计算新内容与核心设定的相似度：
```php
public function calculateSimilarity($vector1, $vector2) {
    $dotProduct = 0;
    $norm1 = 0;
    $norm2 = 0;
    
    for ($i = 0; $i < count($vector1); $i++) {
        $dotProduct += $vector1[$i] * $vector2[$i];
        $norm1 += $vector1[$i] * $vector1[$i];
        $norm2 += $vector2[$i] * $vector2[$i];
    }
    
    $norm1 = sqrt($norm1);
    $norm2 = sqrt($norm2);
    
    return $dotProduct / ($norm1 * $norm2);
}
```

#### 4.3.2 冲突检测逻辑
1. 将新内容转换为向量
2. 在向量数据库中搜索相似的核心设定
3. 计算相似度分数
4. 根据阈值判断是否存在冲突
5. 分析冲突类型和严重程度
6. 生成冲突报告和解决建议

### 4.4 API接口设计

#### 4.4.1 配置管理接口
```php
// 获取用户配置
GET /api/consistency/config

// 更新用户配置
PUT /api/consistency/config

// 测试向量数据库连接
POST /api/consistency/test-vector-db
```

#### 4.4.2 核心设定管理接口
```php
// 获取核心设定列表
GET /api/consistency/core-settings

// 添加核心设定
POST /api/consistency/core-settings

// 更新核心设定
PUT /api/consistency/core-settings/{id}

// 删除核心设定
DELETE /api/consistency/core-settings/{id}

// 批量导入核心设定
POST /api/consistency/core-settings/batch-import
```

#### 4.4.3 一致性检查接口
```php
// 执行一致性检查
POST /api/consistency/check

// 获取检查报告
GET /api/consistency/reports/{id}

// 获取报告列表
GET /api/consistency/reports

// 获取冲突详情
GET /api/consistency/conflicts/{id}
```

## 5. 使用指南

### 5.1 初始配置

1. **启用一致性检查**
   - 登录管理后台
   - 进入"一致性检查"模块
   - 点击"启用一致性检查"开关

2. **配置向量数据库**
   - 选择向量数据库类型
   - 填写连接信息
   - 测试连接是否成功

3. **选择嵌入模型**
   - 从支持的模型列表中选择
   - 配置模型参数
   - 测试模型是否可用

### 5.2 核心设定管理

1. **添加核心设定**
   - 选择设定类型（世界观、角色、事件、规则）
   - 填写标题和内容
   - 添加元数据（可选）
   - 保存并自动向量化

2. **批量导入**
   - 准备CSV或JSON格式的数据文件
   - 选择文件并上传
   - 映射字段
   - 确认导入

### 5.3 一致性检查

1. **实时检查**
   - 在创作过程中，系统会自动检查新内容
   - 发现冲突时会显示警告
   - 点击警告查看详细冲突信息

2. **手动检查**
   - 选择要检查的内容
   - 点击"检查一致性"按钮
   - 查看检查结果和报告

### 5.4 报告分析

1. **查看报告**
   - 进入"报告"页面
   - 选择报告类型和时间范围
   - 查看详细报告内容

2. **冲突分析**
   - 查看冲突类型分布
   - 分析冲突趋势
   - 制定改进策略

## 6. 最佳实践

### 6.1 核心设定管理
- **结构化存储**: 使用结构化的方式存储核心设定，便于向量化
- **定期更新**: 定期更新和完善核心设定，保持其时效性
- **版本控制**: 对核心设定进行版本控制，便于回溯和比较

### 6.2 一致性检查配置
- **合理设置阈值**: 根据项目特点设置合适的相似度阈值
- **分阶段检查**: 在不同创作阶段设置不同的检查策略
- **人工审核**: 结合人工审核，提高检查准确性

### 6.3 冲突处理
- **分级处理**: 根据冲突严重程度分级处理
- **及时解决**: 发现冲突后及时解决，避免累积
- **记录经验**: 记录冲突解决经验，完善知识库

## 7. 故障排除

### 7.1 常见问题

#### 7.1.1 向量数据库连接失败
- 检查网络连接
- 验证连接参数
- 确认数据库服务状态

#### 7.1.2 嵌入模型调用失败
- 检查API密钥
- 验证模型参数
- 确认服务配额

#### 7.1.3 检查结果不准确
- 调整敏感度阈值
- 优化核心设定质量
- 检查嵌入模型适用性

### 7.2 性能优化

#### 7.2.1 向量数据库优化
- 合理设置索引
- 定期清理无用数据
- 使用集群提高性能

#### 7.2.2 检查算法优化
- 使用缓存减少重复计算
- 并行处理提高效率
- 优化向量维度

## 8. 扩展开发

### 8.1 自定义嵌入模型
```php
class CustomEmbeddingGenerator implements EmbeddingGeneratorInterface {
    public function embedText(string $text): array {
        // 实现自定义嵌入逻辑
        return $embedding;
    }
}
```

### 8.2 自定义检查规则
```php
class CustomConsistencyChecker {
    public function checkConsistency($content, $coreSettings) {
        // 实现自定义检查逻辑
        return $conflicts;
    }
}
```

### 8.3 扩展报告格式
```php
class CustomReportGenerator {
    public function generateReport($checkResults) {
        // 实现自定义报告格式
        return $report;
    }
}
```

## 9. 版本历史

### v1.0.0 (2024-02-04)
- 初始版本发布
- 基础一致性检查功能
- 支持主流向量数据库
- 基础管理界面

### 未来计划
- 支持更多向量数据库
- 增强AI分析能力
- 优化用户体验
- 增加协作功能

## 10. 技术支持

如有问题或建议，请联系：
- 邮箱: support@starrynight.com
- 文档: https://docs.starrynight.com/consistency-check
- 社区: https://community.starrynight.com